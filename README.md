## MetaNode stake

### 1. 系统概述

MetaNodeStake 是一个基于区块链的质押系统，支持多种代币的质押，并基于用户质押的代币数量和时间长度分配 MetaNode 代币作为奖励。系统可提供多个质押池，每个池可以独立配置质押代币、奖励计算等。

#### 2. 功能需求

##### 2.1 质押功能

- **输入参数**: 池 ID(_pid)，质押数量(_amount)。
- **前置条件**: 用户已授权足够的代币给合约。
- **后置条件**: 用户的质押代币数量增加，池中的总质押代币数量更新。
- **异常处理**: 质押数量低于最小质押要求时拒绝交易。

##### 2.2 解除质押功能

- **输入参数**: 池 ID(_pid)，解除质押数量(_amount)。
- **前置条件**: 用户质押的代币数量足够。
- **后置条件**: 用户的质押代币数量减少，解除质押请求记录，等待锁定期结束后可提取。
- **异常处理**: 如果解除质押数量大于用户质押的数量，交易失败。

##### 2.3 领取奖励

- **输入参数**: 池 ID(_pid)。
- **前置条件**: 有可领取的奖励。
- **后置条件**: 用户领取其奖励，清除已领取的奖励记录。
- **异常处理**: 如果没有可领取的奖励，不执行任何操作。

##### 2.4 添加和更新质押池

- **输入参数**: 质押代币地址(_stTokenAddress)，池权重(_poolWeight)，最小质押金额(_minDepositAmount)，解除质押锁定区(_unstakeLockedBlocks)。
- **前置条件**: 只有管理员可操作。
- **后置条件**: 创建新的质押池或更新现有池的配置。
- **异常处理**: 权限验证失败或输入数据验证失败。

##### 2.5 合约升级和暂停

- **升级合约**: 只有持有升级角色的账户可执行。
- **暂停/恢复操作**: 可以独立控制质押、解除质押、领奖等操作的暂停和恢复。

#### 3. 数据结构

##### 3.1 Pool

- **stTokenAddress**: 质押代币的地址。
- **poolWeight**: 质押池的权重，影响奖励分配。
- **lastRewardBlock**: 最后一次计算奖励的区块号。
- **accMetaNodePerST**: 每个质押代币累积的 MetaNode 数量。
- **stTokenAmount**: 池中的总质押代币量。
- **minDepositAmount**: 最小质押金额。
- **unstakeLockedBlocks**: 解除质押的锁定区块数。

##### 3.2 User

- **stAmount**: 用户质押的代币数量。
- **finishedMetaNode**: 已分配的 MetaNode 数量。
- **pendingMetaNode**: 待领取的 MetaNode 数量。
- **requests**: 解质押请求列表，每个请求包含解质押数量和解锁区块。

#### 4. 安全需求

- **访问控制**: 使用角色基础的访问控制确保只有授权用户可以执行敏感操作。
- **重入攻击保护**: 使用状态锁定模式防止重入攻击。
- **输入验证**: 所有用户输入必须经过严格验证，包括参数范围检查和数据完整性验证。

#### 5. 事件记录

- 每个关键操作（如质押、解除质押、领奖）都应触发事件，以便外部监听器跟踪和记录状态变化。

#### 6. 接口设计

- 提供标准的 Ethereum 智能合约接口，支持 ERC20 代币操作和自定义合约方法。
- 提供前端界面调用合约的接口说明和示例代码，确保前端可以正确交互并展示合约状态。

## 部署地址(Sepolia网)

- 代币部署地址: 0x11916112B1614b4A1f32fA8b79e3A721b6e6e98a
- 代理合约地址（交互入口）: 0xe5d09Bae324538e8181Ecf316EE461238d292e4E
- 实现合约地址（逻辑）: 0xBF9Ac32Ea815844Da92E6eaEB0d0662818BfB070
- 管理员地址: 0xae18a37156e885c156D76f356C48447957433ae0

## 版本历史

### v1.1.0 (2025.10.30)：部署验证完成与环境适配

- 完成本地 Hardhat 节点与 Sepolia 测试网部署适配，支持自定义私钥安全部署，实现代币 + 质押合约一键部署与自动验证
- 本地与测试网核心功能验证通过，涵盖质押、赎回、奖励领取、权限控制等流程，数据一致性达标

### v1.0.0 (2025.10.30)：模块化重构与测试体系完善

- **核心架构升级**：将原单一合约拆分为5个模块化子合约，实现功能解耦  
  - `MetaNodeStakeStorage.sol`：集中管理状态变量（如`Pool`结构体、用户质押数据），作为所有功能合约的存储层  
  - `MetaNodeAdmin.sol`：封装管理员功能（`addPool`/`setLockBlocks`/权限控制），继承自`Storage`层  
  - `MetaNodeUser.sol`：实现用户核心操作（质押/赎回/提取），通过继承复用存储层变量  
  - `MetaNodeMath.sol`：独立封装奖励计算、安全运算逻辑（如万分之一精度转换、溢出检查），通过库调用减少主合约体积  
  - `MetaNode.sol`：主入口合约，继承`Admin`和`User`模块，聚合所有功能  

- **单元测试体系强化**：  
  - 新增模块化单元测试，按合约职责拆分测试用例 
  - 覆盖跨合约交互场景（如管理员添加池后用户质押的完整性校验）  
  - 补充边界测试：多池数据隔离性、权限交叉调用限制、库函数异常输入处理  

- **兼容性优化**：  
  - 保持与 v0.6.0 版本功能对齐，模块化重构后合约部署体积减少 40%，满足主网 24KB 限制  
  - 升级编译器配置（启用优化器+IR模式），确保模块化调用的 gas 效率  

### v0.6.0 (2025.10.28) 新增基础奖励机制

- 支持独立奖励配置、累计奖励计算与主动领取，优化安全性
- 采用万分之一精度设计奖励公式，规避浮点数运算，奖励率配置直观易控
- 新增奖励开关与合约余额校验，管理员可紧急暂停奖励，防止奖励代币透支
- 优化质押/赎回/提取功能的单元测试

### v0.5.1 (2025.10.28)：完善多资产质押池的单元测试

- 重构requestUnstake测试, 覆盖多池赎回量校验、锁仓期隔离及事件与状态一致性
- 重构withdraw测试, 验证跨池数据隔离、锁仓期拦截逻辑及多资产到账准确性

### v0.5.0 (2025.10.27)：支持多资产质押池

- 新增多池架构，通过Pool结构体管理不同资产（ETH/ERC20）的独立质押信息（地址、总质押量、锁仓期）
- 实现addPool函数，支持管理员动态添加 ERC20 质押池（ETH 池默认初始化，ID=0）
- 质押 / 赎回 / 提取功能适配多池逻辑，按池隔离用户数据，自动区分 ETH 与 ERC20 的转账处理
- 重构stake的单元测试，添加eth/erc20代币的多种质押场景和边界的case

### v0.4.0 (2025.10.26)：强化安全机制

- 引入管理员权限控制（基于 Ownable2Step），限制锁仓参数调整、紧急暂停等敏感操作
- 新增合约暂停 / 恢复功能，异常时可冻结质押、赎回、提取等核心操作
- 增强异常防护：校验合约余额充足性，优化 ETH 转账安全性

### v0.3.0 (2025.10.26)：升级质押机制，新增锁仓逻辑

- 实现「质押（stake）→ 申请赎回（requestUnstake）→ 锁仓期等待(利用区块时间) → 提取（withdraw）」完整流程  
- 核心改进：通过锁仓期（lockBlocks）防止短期频繁操作，增强资金池稳定性，适配长期质押场景  
- 完善测试：覆盖锁仓期内禁止提取、到期正常提取、无锁仓资金拦截等边界场景  

### v0.2.0 (2025.10.26)：实现基础质押功能

- 开发质押（stake）与直接解除质押（unstake）核心函数，支持 ETH 接收与用户质押量记录  
- 完成基础单元测试，验证质押量准确性、ETH 转账安全性  

### v0.1.0 (2025.10.25)：初始化项目架构

- 基于 Hardhat 搭建开发环境，配置编译、测试与部署流程  
- 定义合约基础结构与存储变量（如用户质押信息、总质押量）
